{% extends 'app_synes/base.html' %}
{% load static %}
{% block title %}cadêURacha - {{ jogo.titulo }}{% endblock %}
{% block content %}
<head>
    <link href="{% static 'app_synes/css/detalhes_racha.css' %}" rel="stylesheet">
</head>
<body>
    <div class="pai">
    <div class="fundo shadow" style="width: 926px; height: 379px;">
      <div class="row g-0">
        <div class="col-md-4 d-flex justify-content-center align-items-center flex-wrap">
          {% if jogo.imagem %}
            <img src="{{ jogo.imagem.url }}" class="img-fluid mb-4" alt="Imagem do Racha">
          {% else %}
            <img src="{% static 'app_synes/images/space.jpg' %}" class="img-fluid mb-4" alt="Imagem do Racha">
          {% endif %}
          <p class="text-center w-100"><strong>Jogadores:</strong></p>
          <div class="d-flex flex-wrap gap-2 overflow-auto w-50 h-25 mb-4">
            {% for jogador in jogadores %}
              {% if jogador.foto_perfil %}
                <img src="{{ jogador.foto_perfil.url }}" 
                     class="rounded-circle d-inline-block" 
                     style="width:30px; height:30px;" 
                     alt="Foto de perfil de {{ jogador.username }}"
                     title="{{ jogador.username }}"
                     data-bs-toggle="tooltip"
                     data-bs-placement="top">
              {% else %}
                <img src="{% static 'app_synes/images/user.jpg' %}" 
                     class="rounded-circle d-inline-block" 
                     style="width:30px; height:30px;"
                     alt="Foto de perfil padrão de {{ jogador.username }}"
                     title="{{ jogador.username }}"
                     data-bs-toggle="tooltip"
                     data-bs-placement="top">
              {% endif %}
            {% empty %}
              <p>Nenhum jogador confirmado</p>
            {% endfor %}
          </div>
        </div>
        <div class="col-md-8">
          <div class="card-body">
            <p class="card-title text-truncate w-75" style="font-size: 30px; font-weight: 550">Detalhes de <b><span>{{ jogo.titulo }}</span></b></p>
            <div class="infos d-flex justify-content-between w-100">
              <p class="mb-1 text-truncate w-50" style="font-size: 22px">{{ jogo.arena.nome }} - {{ jogo.arena.endereco }}</p>
              <p class="mb-1 w-50" style="font-size: 22px">Racha com <i class='bx bxs-basketball'></i></p>
            </div>

            <div class="d-flex gap-3 my-3 organizador justify-content-between w-75">
              <div class="pad">
                <p class="text-center" style="font-size: 22px">{{ jogo.horario }}</p>
              </div>
              <div class="pad">
                <p class="text-center" style="font-size: 22px">{{ jogo.data|date:"d/m/Y" }}</p>
              </div>
            </div>
            <p class="text-truncate">{{ jogo.descricao }}</p>
            <div class="row d-flex gap-3 mt-4 w-75 botoes">
                {% if user.is_authenticated %}
                    <div class="col-auto">
                        {% if user in jogo.participantes.all %}
                            <button class="btn btn-danger" onclick="togglePresenca({{ jogo.id }}, false)">
                                <i class="bi bi-x-circle"></i> Cancelar Presença
                            </button>
                        {% else %}
                            <button class="btn btn-success" onclick="togglePresenca({{ jogo.id }}, true)">
                                <i class="bi bi-check-circle"></i> Confirmar Presença
                            </button>
                        {% endif %}
                    </div>
                    
                    <div class="col-auto">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="levarBola" 
                                   {% if user.levar_bola %}checked{% endif %}
                                   onchange="toggleLevarBola(this.checked)">
                            <label class="form-check-label" for="levarBola">
                                <i class="bx bxs-basketball"></i> Vou Levar Bola
                            </label>
                        </div>
                    </div>
                {% else %}
                    <div class="col-12">
                        <p>Para confirmar presença, faça <a href="{% url 'logar' %}">login</a> ou <a href="{% url 'cadastrar_usuario' %}">cadastre-se</a>.</p>
                    </div>
                {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });

        function togglePresenca(jogoId, confirmar) {
            fetch('/toggle_presenca/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    jogo_id: jogoId,
                    confirmar: confirmar
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.message);
                }
            });
        }

        function toggleLevarBola(checked) {
            fetch('/toggle_levar_bola/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    levar_bola: checked
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.message);
                }
            });
        }
    </script>
</body>
{% endblock %}